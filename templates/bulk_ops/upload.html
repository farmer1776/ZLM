{% extends "base.html" %}

{% block title %}Bulk Operations - {{ APP_NAME }}{% endblock %}

{% block content %}
<div class="page-header">
    <h1>Bulk Operations</h1>
</div>

{% if preview %}
<!-- Preview Mode -->
<div class="card mb-3">
    <div class="card-header">Preview - {{ bulk_op.operation_type_display }}</div>
    <div class="card-body">
        <p>File: <strong>{{ bulk_op.filename }}</strong> | Total emails: <strong>{{ bulk_op.total_count }}</strong></p>

        {% if not_found %}
        <div class="alert alert-warning">
            <strong>{{ not_found|length }} email(s) not found:</strong>
            <ul class="mb-0 mt-1">
                {% for email in not_found %}
                <li>{{ email }}</li>
                {% endfor %}
            </ul>
        </div>
        {% endif %}

        <h6 style="color: var(--text-muted);" class="mt-3">Accounts to process ({{ found_accounts|length }}):</h6>
        <div class="card-body p-0">
            <table class="table">
                <thead>
                    <tr>
                        <th>Email</th>
                        <th>Current Status</th>
                    </tr>
                </thead>
                <tbody>
                    {% for account in found_accounts %}
                    <tr>
                        <td>{{ account.email }}</td>
                        <td>{{ account.status }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <div class="mt-3 d-flex gap-2">
            <a href="/bulk/{{ bulk_op.id }}/execute/" id="bulk-execute-btn" class="btn btn-primary">
                Execute {{ bulk_op.operation_type_display }}
            </a>
            <a href="/bulk/" class="btn btn-outline-secondary">Cancel</a>
        </div>
    </div>
</div>

{% else %}
<!-- Upload Form -->
<div class="row g-3">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">Upload CSV</div>
            <div class="card-body">
                <form method="post" enctype="multipart/form-data">
                    <div class="mb-3">
                        <label class="form-label" style="color: var(--text-muted); font-size: 0.85rem;">Operation Type</label>
                        <select name="operation_type" class="form-select bg-dark text-light border-secondary">
                            {% for value, label in operation_type_choices %}
                            <option value="{{ value }}">{{ label }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label" style="color: var(--text-muted); font-size: 0.85rem;">CSV File</label>
                        <input type="file" name="csv_file" accept=".csv" class="form-control bg-dark text-light border-secondary">
                        <div style="color: var(--text-muted); font-size: 0.8rem; margin-top: 0.5rem;">
                            CSV file with one email address per line (or column). Max 5MB.
                        </div>
                    </div>
                    <button type="submit" class="btn btn-primary">Upload &amp; Preview</button>
                </form>
            </div>
        </div>
    </div>

    <div class="col-md-6">
        <div class="card">
            <div class="card-header">Recent Operations</div>
            <div class="card-body p-0">
                <table class="table">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Type</th>
                            <th>File</th>
                            <th>Status</th>
                            <th></th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for op in recent_ops %}
                        <tr>
                            <td style="font-size: 0.85rem;">{{ op.created_at|timesince }} ago</td>
                            <td>{{ op.operation_type_display }}</td>
                            <td style="font-size: 0.85rem;">{{ op.filename }}</td>
                            <td>
                                <span class="badge {% if op.status == 'completed' %}bg-success{% elif op.status == 'failed' %}bg-danger{% elif op.status == 'processing' %}bg-info{% else %}bg-secondary{% endif %}">
                                    {{ op.status_display }}
                                </span>
                            </td>
                            <td><a href="/bulk/{{ op.id }}/results/" class="btn btn-sm btn-outline-secondary">View</a></td>
                        </tr>
                        {% else %}
                        <tr><td colspan="5" style="color: var(--text-muted); text-align: center;">No operations yet.</td></tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>
{% endif %}
{% endblock %}
